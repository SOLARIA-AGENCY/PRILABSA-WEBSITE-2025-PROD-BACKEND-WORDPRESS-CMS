version: '3.8'

################################################################################
# PRILABSA WordPress Headless - Enhanced Docker Compose Configuration
#
# This configuration provides a production-ready Docker environment for
# WordPress headless CMS with all necessary services and optimizations.
#
# FEATURES:
# - WordPress 6.6+ with PHP 8.4 and Apache
# - MySQL 8.0 with optimized settings
# - Redis caching layer
# - phpMyAdmin for database management
# - WP-CLI for automation
# - Nginx reverse proxy (optional)
# - Health checks for all services
# - Environment-based configuration
# - Volume persistence
# - Network isolation
# - Resource limits
#
# DEPLOYMENT INSTRUCTIONS:
# 1. Copy this file to your project root as docker-compose.yml
# 2. Create .env file with required variables (see ENVIRONMENT section)
# 3. Run: docker-compose up -d
# 4. Access: http://localhost:8080 (or configured port)
# 5. Complete WordPress installation via browser or WP-CLI
#
# PRODUCTION CONSIDERATIONS:
# - Change all default passwords
# - Configure external volumes for backups
# - Enable SSL/TLS with Let's Encrypt
# - Set resource limits based on server capacity
# - Configure monitoring and logging
# - Implement backup strategy
#
# @package PRILABSA_Headless_WordPress
# @version 2.0.0
################################################################################

################################################################################
# ENVIRONMENT VARIABLES
################################################################################
#
# Create a .env file in the same directory with these variables:
#
# # Database Configuration
# MYSQL_ROOT_PASSWORD=your_secure_root_password_here
# MYSQL_DATABASE=prilabsa_wp_local
# MYSQL_USER=wp_user
# MYSQL_PASSWORD=your_secure_wp_password_here
#
# # WordPress Configuration
# WORDPRESS_DB_HOST=db:3306
# WORDPRESS_DB_NAME=prilabsa_wp_local
# WORDPRESS_DB_USER=wp_user
# WORDPRESS_DB_PASSWORD=your_secure_wp_password_here
# WORDPRESS_TABLE_PREFIX=prilabsa_
# WORDPRESS_DEBUG=1
#
# # WordPress Site Configuration
# WORDPRESS_SITE_URL=http://localhost:8080
# WORDPRESS_HOME_URL=http://localhost:8080
# WORDPRESS_ADMIN_EMAIL=admin@prilabsa.local
#
# # JWT Authentication
# JWT_SECRET_KEY=your_jwt_secret_key_64_chars_minimum_here
#
# # CORS Configuration
# FRONTEND_URL=http://localhost:5173
#
# # Redis Configuration
# REDIS_PASSWORD=your_redis_password_here
#
# # PHP Configuration
# PHP_MEMORY_LIMIT=512M
# PHP_UPLOAD_MAX_FILESIZE=300M
# PHP_POST_MAX_SIZE=320M
# PHP_MAX_EXECUTION_TIME=300
#
################################################################################

services:
  ############################################################################
  # MYSQL DATABASE SERVICE
  ############################################################################
  db:
    image: mysql:8.0
    container_name: prilabsa-mysql
    restart: unless-stopped

    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root_password_2025!}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-prilabsa_wp_local}
      MYSQL_USER: ${MYSQL_USER:-wp_user}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-wp_strong_password_2025!}
      MYSQL_CHARACTER_SET_SERVER: utf8mb4
      MYSQL_COLLATION_SERVER: utf8mb4_unicode_ci

    volumes:
      # Persistent database storage
      - db_data:/var/lib/mysql

      # Custom MySQL configuration
      - ./mysql-config/custom.cnf:/etc/mysql/conf.d/custom.cnf:ro

      # Initialization scripts (run only on first startup)
      - ./mysql-init:/docker-entrypoint-initdb.d:ro

      # Backup location
      - ./backups/mysql:/backups

    ports:
      # Expose MySQL port (optional, for external access)
      # Comment out for production if not needed
      - "3306:3306"

    networks:
      - prilabsa-network

    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD:-root_password_2025!}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

    # Resource limits (adjust based on server capacity)
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

    # Security options
    security_opt:
      - no-new-privileges:true

  ############################################################################
  # REDIS CACHE SERVICE
  ############################################################################
  redis:
    image: redis:7-alpine
    container_name: prilabsa-redis
    restart: unless-stopped

    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD:-redis_password_2025!}
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --appendonly yes

    volumes:
      # Persistent Redis data
      - redis_data:/data

    ports:
      # Expose Redis port (optional)
      - "6379:6379"

    networks:
      - prilabsa-network

    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 10s

    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

  ############################################################################
  # WORDPRESS SERVICE
  ############################################################################
  wordpress:
    image: wordpress:6.6-php8.4-apache
    container_name: prilabsa-wordpress
    restart: unless-stopped

    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy

    environment:
      # Database connection
      WORDPRESS_DB_HOST: ${WORDPRESS_DB_HOST:-db:3306}
      WORDPRESS_DB_NAME: ${WORDPRESS_DB_NAME:-prilabsa_wp_local}
      WORDPRESS_DB_USER: ${WORDPRESS_DB_USER:-wp_user}
      WORDPRESS_DB_PASSWORD: ${WORDPRESS_DB_PASSWORD:-wp_strong_password_2025!}
      WORDPRESS_TABLE_PREFIX: ${WORDPRESS_TABLE_PREFIX:-prilabsa_}

      # WordPress configuration
      WORDPRESS_DEBUG: ${WORDPRESS_DEBUG:-1}
      WORDPRESS_DEBUG_LOG: ${WORDPRESS_DEBUG:-1}
      WORDPRESS_DEBUG_DISPLAY: 0

      # Redis object cache
      WORDPRESS_REDIS_HOST: redis
      WORDPRESS_REDIS_PORT: 6379
      WORDPRESS_REDIS_PASSWORD: ${REDIS_PASSWORD:-redis_password_2025!}

      # Additional WordPress configuration
      WORDPRESS_CONFIG_EXTRA: |
        /* Headless WordPress Configuration */
        define('WP_SITEURL', '${WORDPRESS_SITE_URL:-http://localhost:8080}');
        define('WP_HOME', '${WORDPRESS_HOME_URL:-http://localhost:8080}');

        /* JWT Authentication */
        define('JWT_AUTH_SECRET_KEY', '${JWT_SECRET_KEY:-your-secret-key-change-this-in-production}');
        define('JWT_AUTH_CORS_ENABLE', true);

        /* REST API Configuration */
        define('REST_API_ENABLED', true);
        define('WP_REST_API_MAX_RESULTS', 100);

        /* Security Hardening */
        define('DISALLOW_FILE_EDIT', true);
        define('FORCE_SSL_ADMIN', false);

        /* Performance Optimization */
        define('WP_CACHE', true);
        define('WP_POST_REVISIONS', 5);
        define('AUTOSAVE_INTERVAL', 300);
        define('EMPTY_TRASH_DAYS', 30);

        /* CORS Headers for Headless */
        if (isset($_SERVER['HTTP_ORIGIN'])) {
            $allowed_origins = array(
                'http://localhost:5173',
                'http://localhost:3000',
                'https://productos.prilabsa.com'
            );
            if (in_array($_SERVER['HTTP_ORIGIN'], $allowed_origins)) {
                header("Access-Control-Allow-Origin: " . $_SERVER['HTTP_ORIGIN']);
                header('Access-Control-Allow-Methods: GET, POST, PUT, PATCH, DELETE, OPTIONS');
                header('Access-Control-Allow-Headers: Authorization, Content-Type, X-WP-Nonce, X-Requested-With');
                header('Access-Control-Allow-Credentials: true');
                header('Access-Control-Expose-Headers: X-WP-Total, X-WP-TotalPages');
                header('Access-Control-Max-Age: 3600');
            }
        }

        if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {
            http_response_code(204);
            exit();
        }

        /* Redis Object Cache */
        define('WP_REDIS_HOST', 'redis');
        define('WP_REDIS_PORT', 6379);
        define('WP_REDIS_PASSWORD', '${REDIS_PASSWORD:-redis_password_2025!}');
        define('WP_REDIS_DATABASE', 0);

    volumes:
      # WordPress core files (named volume for persistence)
      - wordpress_data:/var/www/html

      # Development: mount local wp-content for live editing
      - ./wp-content:/var/www/html/wp-content

      # PHP configuration
      - ./templates/php-uploads.ini:/usr/local/etc/php/conf.d/uploads.ini:ro

      # Apache configuration (optional)
      # - ./apache-config/000-default.conf:/etc/apache2/sites-available/000-default.conf:ro

      # Logs
      - ./logs/wordpress:/var/log/wordpress

      # Uploads backup
      - ./backups/uploads:/var/www/html/wp-content/uploads-backup

    ports:
      - "8080:80"

    networks:
      - prilabsa-network

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/wp-json/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G

    # Enable Apache modules
    user: www-data

  ############################################################################
  # WP-CLI SERVICE
  ############################################################################
  wpcli:
    image: wordpress:cli-php8.4
    container_name: prilabsa-wpcli
    restart: "no"

    depends_on:
      wordpress:
        condition: service_healthy

    environment:
      WORDPRESS_DB_HOST: ${WORDPRESS_DB_HOST:-db:3306}
      WORDPRESS_DB_NAME: ${WORDPRESS_DB_NAME:-prilabsa_wp_local}
      WORDPRESS_DB_USER: ${WORDPRESS_DB_USER:-wp_user}
      WORDPRESS_DB_PASSWORD: ${WORDPRESS_DB_PASSWORD:-wp_strong_password_2025!}

    volumes:
      # Share WordPress files with main container
      - wordpress_data:/var/www/html
      - ./wp-content:/var/www/html/wp-content

      # WP-CLI configuration
      - ./wpcli-config/wp-cli.yml:/var/www/html/wp-cli.yml:ro

      # Scripts for automation
      - ./scripts:/scripts:ro

    networks:
      - prilabsa-network

    user: "33:33"  # www-data user

    # Keep container running for exec commands
    command: tail -f /dev/null

  ############################################################################
  # PHPMYADMIN SERVICE
  ############################################################################
  phpmyadmin:
    image: phpmyadmin:latest
    container_name: prilabsa-phpmyadmin
    restart: unless-stopped

    depends_on:
      db:
        condition: service_healthy

    environment:
      PMA_HOST: db
      PMA_PORT: 3306
      PMA_USER: root
      PMA_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root_password_2025!}
      UPLOAD_LIMIT: 300M
      MEMORY_LIMIT: 512M
      MAX_EXECUTION_TIME: 300

    ports:
      - "8081:80"

    networks:
      - prilabsa-network

    volumes:
      # phpMyAdmin configuration
      - ./phpmyadmin-config/config.user.inc.php:/etc/phpmyadmin/config.user.inc.php:ro

    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  ############################################################################
  # NGINX REVERSE PROXY (OPTIONAL)
  ############################################################################
  nginx:
    image: nginx:alpine
    container_name: prilabsa-nginx
    restart: unless-stopped

    depends_on:
      - wordpress

    ports:
      - "80:80"
      - "443:443"

    volumes:
      # Nginx configuration
      - ./nginx-config/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx-config/conf.d:/etc/nginx/conf.d:ro

      # SSL certificates (Let's Encrypt)
      - ./ssl-certs:/etc/nginx/ssl:ro

      # Static files (optional optimization)
      - wordpress_data:/var/www/html:ro

      # Logs
      - ./logs/nginx:/var/log/nginx

    networks:
      - prilabsa-network

    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3

    # Uncomment to enable (disabled by default)
    profiles:
      - production

################################################################################
# VOLUMES
################################################################################
volumes:
  # Database storage (persistent)
  db_data:
    name: prilabsa_mysql_data
    driver: local

  # WordPress files (persistent)
  wordpress_data:
    name: prilabsa_wordpress_data
    driver: local

  # Redis data (persistent)
  redis_data:
    name: prilabsa_redis_data
    driver: local

################################################################################
# NETWORKS
################################################################################
networks:
  prilabsa-network:
    name: prilabsa-network
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

################################################################################
# USAGE INSTRUCTIONS
################################################################################
#
# BASIC COMMANDS:
# ===============
#
# Start all services:
#   docker-compose up -d
#
# Start with Nginx (production profile):
#   docker-compose --profile production up -d
#
# Stop all services:
#   docker-compose down
#
# Stop and remove volumes (DANGER: deletes all data):
#   docker-compose down -v
#
# View logs:
#   docker-compose logs -f
#   docker-compose logs -f wordpress
#   docker-compose logs -f db
#
# Check service status:
#   docker-compose ps
#
# Restart a service:
#   docker-compose restart wordpress
#
# Execute commands in containers:
#   docker-compose exec wordpress bash
#   docker-compose exec db mysql -u root -p
#
# WP-CLI COMMANDS:
# ================
#
# Install WordPress:
#   docker-compose exec wpcli wp core install \
#     --url="http://localhost:8080" \
#     --title="PRILABSA Local Development" \
#     --admin_user="admin_local" \
#     --admin_password="secure_password_here" \
#     --admin_email="admin@prilabsa.local"
#
# Install plugins:
#   docker-compose exec wpcli wp plugin install advanced-custom-fields --activate
#   docker-compose exec wpcli wp plugin install acf-to-rest-api --activate
#   docker-compose exec wpcli wp plugin install jwt-authentication-for-wp-rest-api --activate
#   docker-compose exec wpcli wp plugin install redis-cache --activate
#
# Enable Redis cache:
#   docker-compose exec wpcli wp redis enable
#
# Create custom post type (via plugin or code):
#   docker-compose exec wpcli wp scaffold post-type productos --plugin=prilabsa-productos
#
# Export database:
#   docker-compose exec wpcli wp db export /backups/backup-$(date +%Y%m%d).sql
#
# Import database:
#   docker-compose exec wpcli wp db import /backups/backup-YYYYMMDD.sql
#
# Search and replace URLs (for migration):
#   docker-compose exec wpcli wp search-replace 'http://localhost:8080' 'https://productos.prilabsa.com'
#
# Update WordPress core:
#   docker-compose exec wpcli wp core update
#
# Update plugins:
#   docker-compose exec wpcli wp plugin update --all
#
# BACKUP & RESTORE:
# =================
#
# Backup database:
#   docker-compose exec db mysqldump -u wp_user -p prilabsa_wp_local > backups/db-$(date +%Y%m%d).sql
#
# Backup uploads:
#   docker cp prilabsa-wordpress:/var/www/html/wp-content/uploads ./backups/uploads-$(date +%Y%m%d)
#
# Restore database:
#   docker-compose exec -T db mysql -u wp_user -p prilabsa_wp_local < backups/db-YYYYMMDD.sql
#
# TROUBLESHOOTING:
# ================
#
# Clear Redis cache:
#   docker-compose exec redis redis-cli -a ${REDIS_PASSWORD} FLUSHALL
#
# Rebuild containers:
#   docker-compose down
#   docker-compose build --no-cache
#   docker-compose up -d
#
# Check WordPress configuration:
#   docker-compose exec wpcli wp config list
#
# Check database connection:
#   docker-compose exec wordpress wp db check
#
# Fix file permissions:
#   docker-compose exec wordpress chown -R www-data:www-data /var/www/html
#
# View PHP info:
#   docker-compose exec wordpress php -i
#
# HEALTH CHECKS:
# ==============
#
# Test WordPress API:
#   curl http://localhost:8080/wp-json/
#
# Test database connection:
#   docker-compose exec db mysql -u wp_user -p -e "USE prilabsa_wp_local; SHOW TABLES;"
#
# Test Redis connection:
#   docker-compose exec redis redis-cli -a ${REDIS_PASSWORD} PING
#
# ACCESS POINTS:
# ==============
#
# WordPress Frontend: http://localhost:8080
# WordPress Admin:    http://localhost:8080/wp-admin
# WordPress API:      http://localhost:8080/wp-json/
# phpMyAdmin:         http://localhost:8081
# (Nginx):            http://localhost (if enabled)
#
################################################################################
# END OF CONFIGURATION
################################################################################
