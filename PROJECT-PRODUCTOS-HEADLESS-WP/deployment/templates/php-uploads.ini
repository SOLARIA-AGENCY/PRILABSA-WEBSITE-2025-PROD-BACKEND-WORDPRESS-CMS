; ============================================================================
; PRILABSA WordPress Headless - PHP Configuration for File Uploads
; ============================================================================
;
; This configuration file optimizes PHP settings for WordPress with large
; file uploads (product images, PDFs, catalogs).
;
; DEPLOYMENT INSTRUCTIONS:
; 1. Copy this file to appropriate location based on your PHP setup:
;    - PHP-FPM: /etc/php/8.4/fpm/conf.d/99-prilabsa-uploads.ini
;    - PHP CLI: /etc/php/8.4/cli/conf.d/99-prilabsa-uploads.ini
;    - Apache mod_php: /etc/php/8.4/apache2/conf.d/99-prilabsa-uploads.ini
;
; 2. Adjust values based on your server resources
;
; 3. Restart PHP service:
;    - PHP-FPM: systemctl restart php8.4-fpm
;    - Apache: systemctl restart apache2
;
; 4. Verify settings loaded: php -i | grep -E 'upload_max_filesize|post_max_size|memory_limit'
;
; RECOMMENDED SERVER RESOURCES:
; - Minimum RAM: 2GB (4GB+ recommended for production)
; - Minimum disk space: 20GB free for uploads
; - PHP version: 8.1+ (8.4 recommended)
;
; @package PRILABSA_Headless_WordPress
; @version 1.0.0
; ============================================================================

; ============================================================================
; FILE UPLOAD LIMITS
; ============================================================================

; Maximum size of uploaded files
; This should be larger than the largest file you expect to upload
; Default: 2M | Recommended for WordPress: 64M-256M | PRILABSA: 300M
upload_max_filesize = 300M

; Maximum size of POST data (must be larger than upload_max_filesize)
; This includes all uploaded files in a single request plus form data
; Default: 8M | Recommended: Same or larger than upload_max_filesize
post_max_size = 320M

; Maximum number of files that can be uploaded in a single request
; Default: 20 | Recommended for multiple image uploads: 50-100
max_file_uploads = 100

; ============================================================================
; MEMORY LIMITS
; ============================================================================

; Maximum memory a script can consume
; WordPress requires at least 64M, 256M recommended for image processing
; Default: 128M | Recommended: 256M-512M
memory_limit = 512M

; ============================================================================
; EXECUTION TIME LIMITS
; ============================================================================

; Maximum time in seconds a script is allowed to run
; Increase for large file uploads and image processing
; Default: 30 | Recommended: 300 (5 minutes)
max_execution_time = 300

; Maximum time in seconds for parsing input data (POST, GET, file uploads)
; Should match or exceed max_execution_time
; Default: 60 | Recommended: 300
max_input_time = 300

; Maximum number of input variables accepted
; Prevents form spam but should be high enough for complex forms
; Default: 1000 | Recommended: 3000
max_input_vars = 3000

; ============================================================================
; SESSION CONFIGURATION
; ============================================================================

; Session lifetime in seconds (for WordPress admin sessions)
; Default: 1440 (24 minutes) | Recommended: 7200 (2 hours)
session.gc_maxlifetime = 7200

; Session cookie lifetime (0 = until browser closes)
session.cookie_lifetime = 0

; ============================================================================
; OUTPUT BUFFERING
; ============================================================================

; Output buffering size
; Helps with performance by reducing number of write operations
; Default: 4096 | Recommended: 4096 or higher
output_buffering = 4096

; ============================================================================
; ERROR REPORTING (DEVELOPMENT vs PRODUCTION)
; ============================================================================

; Display errors in output (DISABLE IN PRODUCTION!)
; Development: On | Production: Off
display_errors = Off

; Log errors to file (ENABLE IN PRODUCTION)
; Development: On | Production: On
log_errors = On

; Error log file location (adjust based on your server)
; Make sure PHP has write permissions to this directory
; error_log = /var/log/php/prilabsa-errors.log

; Error reporting level
; Development: E_ALL | Production: E_ALL & ~E_DEPRECATED & ~E_STRICT
error_reporting = E_ALL & ~E_DEPRECATED & ~E_STRICT

; ============================================================================
; OPCODE CACHE (OPCACHE) CONFIGURATION
; ============================================================================

; Enable OPcache for better performance
opcache.enable = 1

; Enable OPcache for CLI (useful for WP-CLI)
opcache.enable_cli = 1

; Memory allocated to OPcache (in MB)
; Recommended: 128-256MB for WordPress
opcache.memory_consumption = 256

; Amount of memory for interned strings (in MB)
; Recommended: 16-32MB
opcache.interned_strings_buffer = 32

; Maximum number of cached files
; Recommended: 10000+ for WordPress with plugins
opcache.max_accelerated_files = 20000

; Validate cached files on every request (disable in production)
; Development: 1 | Production: 0
opcache.validate_timestamps = 0

; Revalidation frequency in seconds (only if validate_timestamps = 1)
; opcache.revalidation_freq = 60

; ============================================================================
; SECURITY SETTINGS
; ============================================================================

; Disable dangerous PHP functions
disable_functions = exec,passthru,shell_exec,system,proc_open,popen,curl_exec,curl_multi_exec,parse_ini_file,show_source

; Restrict PHP file operations to specific directory
; Adjust path to match your WordPress installation
; open_basedir = /var/www/html/wordpress:/tmp:/usr/share/php

; Prevent PHP from exposing version information
expose_php = Off

; ============================================================================
; DATE/TIME CONFIGURATION
; ============================================================================

; Default timezone
; Adjust to your server's timezone
; List: https://www.php.net/manual/en/timezones.php
date.timezone = America/Guayaquil

; ============================================================================
; REALPATH CACHE (PERFORMANCE)
; ============================================================================

; Realpath cache size (speeds up file path resolution)
; Default: 4096K | Recommended: 4096K or higher
realpath_cache_size = 4096K

; Realpath cache TTL in seconds
; Default: 120 | Recommended: 600
realpath_cache_ttl = 600

; ============================================================================
; DATABASE CONFIGURATION (MySQL/MariaDB)
; ============================================================================

; Default socket location for MySQL/MariaDB
; mysqli.default_socket = /var/run/mysqld/mysqld.sock
; pdo_mysql.default_socket = /var/run/mysqld/mysqld.sock

; ============================================================================
; MULTIBYTE STRING SETTINGS
; ============================================================================

; Default character encoding
mbstring.language = UTF-8
mbstring.internal_encoding = UTF-8
mbstring.http_output = UTF-8
mbstring.encoding_translation = On

; ============================================================================
; ENVIRONMENT-SPECIFIC CONFIGURATIONS
; ============================================================================

; DEVELOPMENT ENVIRONMENT
; Uncomment these for local/dev environments
; display_errors = On
; display_startup_errors = On
; error_reporting = E_ALL
; opcache.validate_timestamps = 1
; opcache.revalidation_freq = 2

; STAGING ENVIRONMENT
; Similar to production but with more logging
; display_errors = Off
; log_errors = On
; error_reporting = E_ALL

; PRODUCTION ENVIRONMENT
; Maximum security and performance
; display_errors = Off
; log_errors = On
; error_reporting = E_ALL & ~E_DEPRECATED & ~E_STRICT
; opcache.validate_timestamps = 0
; expose_php = Off

; ============================================================================
; WORDPRESS-SPECIFIC OPTIMIZATIONS
; ============================================================================

; Increase default socket timeout for external API calls
default_socket_timeout = 300

; Allow WordPress to make URL connections
allow_url_fopen = On

; Enable GD library for image processing (if available)
; extension=gd

; Enable ZIP extension for plugin/theme installation
; extension=zip

; Enable XML extensions for RSS/XML-RPC
; extension=xml
; extension=xmlreader
; extension=xmlwriter

; Enable cURL for external requests
; extension=curl

; Enable MySQL/MariaDB support
; extension=mysqli
; extension=pdo_mysql

; Enable internationalization support
; extension=intl

; Enable image EXIF data reading
; extension=exif

; Enable multibyte string support
; extension=mbstring

; ============================================================================
; END OF CONFIGURATION
; ============================================================================

; ============================================================================
; VERIFICATION COMMANDS:
; ============================================================================
;
; Check loaded PHP configuration:
;   php -i | grep -E 'upload_max_filesize|post_max_size|memory_limit|max_execution_time'
;
; Check loaded extensions:
;   php -m
;
; Check PHP version:
;   php -v
;
; Check PHP-FPM status:
;   systemctl status php8.4-fpm
;
; Test PHP configuration:
;   php -r "phpinfo();" | grep -i upload
;
; ============================================================================

; ============================================================================
; POST-DEPLOYMENT CHECKLIST:
; ============================================================================
;
; [ ] File copied to correct PHP configuration directory
; [ ] Values adjusted for server resources
; [ ] PHP service restarted
; [ ] Configuration verified with phpinfo()
; [ ] File upload tested in WordPress admin
; [ ] Image processing tested (thumbnail generation)
; [ ] Error logging configured and tested
; [ ] OPcache enabled and working
; [ ] Timezone set correctly
; [ ] Production security settings enabled
; [ ] Memory limits appropriate for server
; [ ] Execution times tested with large uploads
; [ ] WordPress health check shows no PHP issues
;
; TEST UPLOAD:
; Create a test file and upload through WordPress admin:
;   dd if=/dev/zero of=test-150mb.bin bs=1M count=150
;   Upload via Media Library and verify success
;
; MONITOR LOGS:
;   tail -f /var/log/php/prilabsa-errors.log
;   tail -f /var/log/php8.4-fpm.log
;
; PERFORMANCE TEST:
;   ab -n 100 -c 10 http://your-domain.com/
;   wrk -t4 -c100 -d30s http://your-domain.com/
;
; ============================================================================

; ============================================================================
; TROUBLESHOOTING:
; ============================================================================
;
; ISSUE: Uploads fail with "File size exceeds upload_max_filesize"
; SOLUTION: Increase upload_max_filesize and post_max_size, restart PHP
;
; ISSUE: PHP scripts timeout during upload
; SOLUTION: Increase max_execution_time and max_input_time
;
; ISSUE: Memory exhausted errors
; SOLUTION: Increase memory_limit (check available server RAM first)
;
; ISSUE: Changes not taking effect
; SOLUTION: Restart PHP service and clear OPcache
;   systemctl restart php8.4-fpm
;   php -r "opcache_reset();"
;
; ISSUE: OPcache not working
; SOLUTION: Verify opcache extension is loaded
;   php -m | grep opcache
;   If not listed, enable in php.ini: zend_extension=opcache.so
;
; ============================================================================
