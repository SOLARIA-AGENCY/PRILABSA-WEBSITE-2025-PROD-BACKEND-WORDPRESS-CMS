# ============================================================================
# PRILABSA WordPress Headless - Nginx Configuration
# ============================================================================
#
# This configuration provides a complete Nginx setup for WordPress headless
# operation with optimal performance, security, and CORS support.
#
# DEPLOYMENT INSTRUCTIONS:
# 1. Copy this file to /etc/nginx/sites-available/prilabsa-wordpress
# 2. Update {{DOMAIN}}, {{SERVER_IP}}, and paths to match your environment
# 3. Create symlink: ln -s /etc/nginx/sites-available/prilabsa-wordpress /etc/nginx/sites-enabled/
# 4. Test configuration: nginx -t
# 5. Reload Nginx: systemctl reload nginx
#
# REQUIRED COMPONENTS:
# - PHP-FPM (php8.4-fpm or compatible)
# - SSL certificates (Let's Encrypt recommended)
# - Nginx modules: http_ssl, http_v2, http_gzip
#
# PERFORMANCE FEATURES:
# - HTTP/2 support
# - FastCGI caching
# - Gzip compression
# - Browser caching headers
# - Rate limiting for security
#
# @package PRILABSA_Headless_WordPress
# @version 1.0.0
# ============================================================================

# ============================================================================
# RATE LIMITING ZONES (DDoS Protection)
# ============================================================================

# Limit requests per IP address
limit_req_zone $binary_remote_addr zone=wordpress_limit:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=30r/s;
limit_req_zone $binary_remote_addr zone=login_limit:10m rate=2r/m;

# Limit concurrent connections per IP
limit_conn_zone $binary_remote_addr zone=conn_limit:10m;

# ============================================================================
# FASTCGI CACHE CONFIGURATION
# ============================================================================

fastcgi_cache_path /var/cache/nginx/prilabsa levels=1:2 keys_zone=PRILABSA:100m inactive=60m;
fastcgi_cache_key "$scheme$request_method$host$request_uri";
fastcgi_cache_use_stale error timeout invalid_header http_500;
fastcgi_cache_bypass $http_x_no_cache;
fastcgi_no_cache $http_x_no_cache;

# ============================================================================
# UPSTREAM PHP-FPM CONFIGURATION
# ============================================================================

upstream php_prilabsa {
    # Unix socket (recommended for performance)
    server unix:/var/run/php/php8.4-fpm.sock;

    # Alternative: TCP socket
    # server 127.0.0.1:9000;

    # Connection management
    keepalive 32;
}

# ============================================================================
# HTTP TO HTTPS REDIRECT (PRODUCTION ONLY)
# ============================================================================

server {
    listen 80;
    listen [::]:80;

    server_name {{DOMAIN}} www.{{DOMAIN}};

    # Allow Let's Encrypt validation
    location ^~ /.well-known/acme-challenge/ {
        root /var/www/html;
        allow all;
    }

    # Redirect all HTTP to HTTPS
    location / {
        return 301 https://$server_name$request_uri;
    }
}

# ============================================================================
# HTTPS SERVER BLOCK (PRODUCTION)
# ============================================================================

server {
    # ========================================================================
    # BASIC SERVER CONFIGURATION
    # ========================================================================

    listen 443 ssl http2;
    listen [::]:443 ssl http2;

    server_name {{DOMAIN}} www.{{DOMAIN}};

    # Document root
    root /var/www/html/wordpress;
    index index.php index.html index.htm;

    # Charset
    charset utf-8;

    # ========================================================================
    # SSL/TLS CONFIGURATION
    # ========================================================================

    # SSL certificates (Let's Encrypt)
    ssl_certificate /etc/letsencrypt/live/{{DOMAIN}}/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/{{DOMAIN}}/privkey.pem;
    ssl_trusted_certificate /etc/letsencrypt/live/{{DOMAIN}}/chain.pem;

    # SSL protocols and ciphers (modern configuration)
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';
    ssl_prefer_server_ciphers off;

    # SSL session caching
    ssl_session_cache shared:SSL:50m;
    ssl_session_timeout 1d;
    ssl_session_tickets off;

    # OCSP stapling
    ssl_stapling on;
    ssl_stapling_verify on;
    resolver 8.8.8.8 8.8.4.4 valid=300s;
    resolver_timeout 5s;

    # ========================================================================
    # SECURITY HEADERS
    # ========================================================================

    # HSTS (HTTP Strict Transport Security)
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

    # Prevent clickjacking
    add_header X-Frame-Options "SAMEORIGIN" always;

    # XSS protection
    add_header X-XSS-Protection "1; mode=block" always;

    # Prevent MIME sniffing
    add_header X-Content-Type-Options "nosniff" always;

    # Referrer policy
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # Content Security Policy
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https://productos.prilabsa.com http://localhost:5173" always;

    # Remove server signature
    server_tokens off;
    more_clear_headers 'Server';
    more_clear_headers 'X-Powered-By';

    # ========================================================================
    # CORS CONFIGURATION (HEADLESS WORDPRESS)
    # ========================================================================

    # Map to determine CORS origin
    map $http_origin $cors_origin {
        default "";
        "~^https?://(localhost:5173|productos\.prilabsa\.com|.*\.prilabsa\.com)$" $http_origin;
    }

    # CORS headers for API requests
    location ~* ^/wp-json/ {
        # CORS headers
        add_header 'Access-Control-Allow-Origin' $cors_origin always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, PATCH, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, X-WP-Nonce, X-Requested-With' always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        add_header 'Access-Control-Expose-Headers' 'X-WP-Total, X-WP-TotalPages' always;
        add_header 'Access-Control-Max-Age' '3600' always;

        # Handle preflight OPTIONS requests
        if ($request_method = 'OPTIONS') {
            return 204;
        }

        # Rate limiting for API
        limit_req zone=api_limit burst=50 nodelay;
        limit_conn conn_limit 10;

        try_files $uri $uri/ /index.php?$args;
    }

    # ========================================================================
    # LOGGING
    # ========================================================================

    access_log /var/log/nginx/prilabsa-wordpress-access.log;
    error_log /var/log/nginx/prilabsa-wordpress-error.log warn;

    # ========================================================================
    # FILE UPLOAD LIMITS
    # ========================================================================

    client_max_body_size 300M;
    client_body_timeout 300s;
    client_body_buffer_size 128k;

    # ========================================================================
    # WORDPRESS PERMALINKS
    # ========================================================================

    location / {
        try_files $uri $uri/ /index.php?$args;

        # Rate limiting
        limit_req zone=wordpress_limit burst=20 nodelay;
        limit_conn conn_limit 10;
    }

    # ========================================================================
    # PHP-FPM CONFIGURATION
    # ========================================================================

    location ~ \.php$ {
        try_files $uri =404;

        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass php_prilabsa;
        fastcgi_index index.php;

        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $fastcgi_path_info;

        # FastCGI timeouts
        fastcgi_connect_timeout 300s;
        fastcgi_send_timeout 300s;
        fastcgi_read_timeout 300s;

        # FastCGI buffers
        fastcgi_buffer_size 128k;
        fastcgi_buffers 256 16k;
        fastcgi_busy_buffers_size 256k;
        fastcgi_temp_file_write_size 256k;

        # Pass Authorization header for JWT
        fastcgi_param HTTP_AUTHORIZATION $http_authorization;

        # FastCGI caching (skip for admin and logged-in users)
        set $skip_cache 0;

        # Don't cache POSTs
        if ($request_method = POST) {
            set $skip_cache 1;
        }

        # Don't cache admin or login pages
        if ($request_uri ~* "/wp-admin/|/wp-login.php|/xmlrpc.php") {
            set $skip_cache 1;
        }

        # Don't cache if logged in
        if ($http_cookie ~* "wordpress_logged_in") {
            set $skip_cache 1;
        }

        fastcgi_cache_bypass $skip_cache;
        fastcgi_no_cache $skip_cache;
        fastcgi_cache PRILABSA;
        fastcgi_cache_valid 200 301 302 60m;
        fastcgi_cache_valid 404 10m;

        add_header X-FastCGI-Cache $upstream_cache_status;
    }

    # ========================================================================
    # SECURITY: PROTECT SENSITIVE FILES
    # ========================================================================

    # Deny access to wp-config.php
    location ~* wp-config\.php {
        deny all;
    }

    # Deny access to .htaccess and hidden files
    location ~ /\. {
        deny all;
    }

    # Deny access to readme, license, and other WordPress files
    location ~* ^/(readme|license|wp-config-sample)\.?(txt|html|php)$ {
        deny all;
    }

    # Disable XML-RPC (prevents DDoS attacks)
    location = /xmlrpc.php {
        deny all;
        access_log off;
        log_not_found off;
    }

    # Protect wp-includes
    location ~* ^/wp-includes/.*\.php$ {
        deny all;
    }

    # Deny PHP execution in uploads directory
    location ~* ^/wp-content/uploads/.*\.php$ {
        deny all;
    }

    # ========================================================================
    # STATIC ASSET CACHING
    # ========================================================================

    # CSS, JavaScript, Media files
    location ~* \.(css|js|jpg|jpeg|png|gif|ico|webp|svg|woff|woff2|ttf|otf|eot)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
        add_header X-Content-Type-Options "nosniff" always;
        access_log off;
        log_not_found off;
    }

    # PDFs and documents
    location ~* \.(pdf|doc|docx|xls|xlsx)$ {
        expires 30d;
        add_header Cache-Control "public";
        add_header X-Content-Type-Options "nosniff" always;
    }

    # ========================================================================
    # WORDPRESS ADMIN PROTECTION
    # ========================================================================

    # Rate limit WordPress login
    location = /wp-login.php {
        limit_req zone=login_limit burst=2 nodelay;
        limit_conn conn_limit 3;

        include fastcgi_params;
        fastcgi_pass php_prilabsa;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    }

    # Protect wp-admin
    location ~* ^/wp-admin/ {
        limit_req zone=wordpress_limit burst=10 nodelay;
        limit_conn conn_limit 5;

        try_files $uri $uri/ /index.php?$args;
    }

    # ========================================================================
    # HEALTH CHECK ENDPOINT
    # ========================================================================

    location = /health {
        access_log off;
        add_header Content-Type text/plain;
        return 200 "OK\n";
    }

    # ========================================================================
    # DENY ACCESS TO HIDDEN FILES (EXCEPT .well-known)
    # ========================================================================

    location ~ /\.(?!well-known) {
        deny all;
    }
}

# ============================================================================
# LOCAL DEVELOPMENT SERVER (HTTP ONLY)
# ============================================================================

server {
    listen 80;
    listen [::]:80;

    server_name localhost 127.0.0.1;

    root /var/www/html/wordpress;
    index index.php index.html index.htm;

    charset utf-8;

    # Logging
    access_log /var/log/nginx/prilabsa-local-access.log;
    error_log /var/log/nginx/prilabsa-local-error.log debug;

    # File upload limits
    client_max_body_size 300M;

    # CORS for local development
    add_header 'Access-Control-Allow-Origin' 'http://localhost:5173' always;
    add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, PATCH, DELETE, OPTIONS' always;
    add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, X-WP-Nonce, X-Requested-With' always;
    add_header 'Access-Control-Allow-Credentials' 'true' always;

    # Handle OPTIONS requests
    if ($request_method = 'OPTIONS') {
        return 204;
    }

    # WordPress permalinks
    location / {
        try_files $uri $uri/ /index.php?$args;
    }

    # PHP processing
    location ~ \.php$ {
        try_files $uri =404;
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass php_prilabsa;
        fastcgi_index index.php;

        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $fastcgi_path_info;
        fastcgi_param HTTP_AUTHORIZATION $http_authorization;

        fastcgi_connect_timeout 300s;
        fastcgi_send_timeout 300s;
        fastcgi_read_timeout 300s;
    }

    # Static files
    location ~* \.(css|js|jpg|jpeg|png|gif|ico|webp|svg|woff|woff2|ttf|otf|eot)$ {
        expires 7d;
        access_log off;
    }

    # Deny access to sensitive files
    location ~* wp-config\.php {
        deny all;
    }

    location ~ /\. {
        deny all;
    }
}

# ============================================================================
# GZIP COMPRESSION
# ============================================================================

gzip on;
gzip_vary on;
gzip_proxied any;
gzip_comp_level 6;
gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss application/rss+xml font/truetype font/opentype application/vnd.ms-fontobject image/svg+xml;
gzip_disable "msie6";

# ============================================================================
# END OF CONFIGURATION
# ============================================================================

# ============================================================================
# POST-DEPLOYMENT CHECKLIST:
# ============================================================================
#
# [ ] Replace {{DOMAIN}} with actual domain
# [ ] Replace {{SERVER_IP}} if needed
# [ ] Update document root path
# [ ] Configure SSL certificates (certbot --nginx)
# [ ] Verify PHP-FPM socket path
# [ ] Create cache directory: mkdir -p /var/cache/nginx/prilabsa
# [ ] Set correct permissions: chown -R www-data:www-data /var/cache/nginx/prilabsa
# [ ] Test configuration: nginx -t
# [ ] Enable site: ln -s /etc/nginx/sites-available/prilabsa-wordpress /etc/nginx/sites-enabled/
# [ ] Reload Nginx: systemctl reload nginx
# [ ] Test CORS from frontend
# [ ] Verify JWT authentication works
# [ ] Check FastCGI cache hits
# [ ] Monitor logs for errors
# [ ] Test rate limiting
# [ ] Verify SSL/TLS configuration (ssllabs.com)
#
# USEFUL COMMANDS:
# - Test config: nginx -t
# - Reload: systemctl reload nginx
# - Restart: systemctl restart nginx
# - Check status: systemctl status nginx
# - View logs: tail -f /var/log/nginx/prilabsa-wordpress-error.log
# - Clear cache: rm -rf /var/cache/nginx/prilabsa/*
#
# ============================================================================
