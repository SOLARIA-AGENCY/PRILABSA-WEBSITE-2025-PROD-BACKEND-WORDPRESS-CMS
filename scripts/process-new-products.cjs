const fs = require('fs');
const path = require('path');

const jsonPath = path.resolve(__dirname, '../MODULO PRODUCTOS PRILABSA CATALOGO JULIO 2025/PRILABSA_CATALOGO_WEB_2025.json');
const outputPath = path.resolve(__dirname, '../src/data/products/julio-2025.ts');

const rawData = fs.readFileSync(jsonPath);
const data = JSON.parse(rawData);

const newProducts = data.productos.map(p => {
  const slug = p.nombre.toLowerCase().replace(/ /g, '-').replace(/[^\w-]+/g, '');
  
  const specifications = p.especificaciones.split('\n').map(spec => {
    const parts = spec.split(':');
    return { key: parts[0]?.trim() || '', value: parts.slice(1).join(':').trim() || '' };
  }).filter(s => s.key && s.value);

  const benefits = p.beneficios.split('\n').map(b => b.trim().replace(/•/g, '')).filter(b => b);
  const presentation = p.presentacion.split('\n').map(p => p.trim().replace(/•/g, '')).filter(p => p);

  // Estructura OptimizedProduct correcta
  return {
    id: p.codigo,
    slug: slug,
    codigo: p.codigo,
    name: p.nombre,
    description: p.descripcion,
    specifications: specifications,
    category: p.categoria,
    subcategory: '',
    assets: {
      image: p.imagen ? {
        filename: p.imagen,
        path: `/assets/productos/images/${p.imagen}`,
        extension: path.extname(p.imagen),
        size: 0,
        exists: true
      } : undefined,
      pdf: p.pdf ? {
        filename: p.pdf,
        path: `/assets/productos/pdfs/${p.pdf}`,
        size: '0KB',
        downloadUrl: `/assets/productos/pdfs/${p.pdf}`,
        exists: true
      } : undefined
    },
    metadata: {
      lastModified: new Date(),
      autoGenerated: true,
      needsReview: false,
      completenessScore: 0.9,
      featured: false
    },
    seo: {
      title: `Comprar ${p.nombre} | PRILABSA`,
      description: p.descripcion,
      keywords: [p.nombre, p.categoria, p.codigo]
    },
    benefits: benefits,
    presentation: presentation,
    tags: [p.categoria]
  };
});

const outputContent = `import { OptimizedProduct } from './types';\n\nexport const productsJulio2025: OptimizedProduct[] = ${JSON.stringify(newProducts, null, 2)};\n\nexport default productsJulio2025;\n`;

fs.writeFileSync(outputPath, outputContent);

console.log(`Se han procesado ${newProducts.length} productos y guardado en ${outputPath}`);

console.log('\nArchivos de imagen a copiar:');
data.productos.forEach(p => console.log(p.imagen));

console.log('\nArchivos PDF a copiar:');
data.productos.forEach(p => console.log(p.pdf));